<!-- ATTENTION: avant de faire le copier/coller dans HAL, descendre jusqu'au premier <p> et supprimer tout ce qui se trouve avant (il faut virer tout le <head>)

Le but des quelques lignes ci-dessous est simplement de mimer la structure du site HAL pour que l'on puisse prévisualiser le rendu (et debugger le javascript) dans un navigateur web.

<html>
<head>
<link rel="stylesheet" href="http://static.ccsd.cnrs.fr/v3/css/bootstrap.css" type="text/css" media="screen">
<link rel="stylesheet" href="http://static.ccsd.cnrs.fr/css/ccsd.css" type="text/css" media="screen">
<link rel="stylesheet" href="http://aurehal.archives-ouvertes.fr/css/hal.css" type="text/css" media="screen">
<link href="https://hal.archives-ouvertes.fr/BCL/public/style.css" rel="stylesheet" type="text/css" >
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
<script src="https://hal.archives-ouvertes.fr/BCL/public/collection_hal.js"></script>
</head>
<body>

<!-- copier/coller dans HAL le code ci-dessous : -->

<script src="../public/lazy.js"></script>
<script src="../public/config.js"></script>
<p><strong>Formes auteurs des membres du labo ayant au moins une publication dans HAL (y compris en-dehors de la collection)&nbsp;:</strong></p>
<p><em>Note&nbsp;: dans ce tableau, les statistiques sur les dépôts correspondent uniquement aux dépôts présents dans la collection<script>document.write(" "+my_config.code_collection);</script>.</em></p>
<p id="mybiblio-requirements" class="alert alert-fixed alert-danger">Pour continuer, vous devez activer Javascript dans votre navigateur internet, puis recharger cette page.<br />Please enable Javascript in your browser, then reload this page.</p>
<aside class="legende" style="display:none;"><strong>Légende&nbsp;:</strong>
<div class="parti">Membre parti du laboratoire</div>
<div class="idhal-manquant">Idhal manquant</div>
<div class="inconnu">Inconnu (absent de la liste des membres du labo)<br/><i>=&gt; Vérifier que le prénom est bien renseigné en entier.</i></div>
</aside>
<table id='liste_membres_labo'>
</table>
<script>// <![CDATA[

var facet_limit_for_query1 = 9999;
var facet_limit_for_query2 = 9999;

/* facettes supplémentaires permettant de récupérer les dates des derniers dépôts associés à chaque forme auteur : 
   (si cette info ne vous est pas utile, vous pouvez mettre les 2 lignes ci-dessous en commentaires afin d'améliorer les performances)
*/
facet_limit_for_query1 = facet_limit_for_query1 + '&facet.pivot=authIdHal_s,submittedDateY_i,submittedDateM_i,submittedDateD_i&facet.sort=index';
facet_limit_for_query2 = facet_limit_for_query2 + '&facet.pivot=submittedDateY_i,submittedDateM_i,submittedDateD_i,authId_i&facet.sort=index';

// Localization: currently available languages are "en" and "fr".
var lang=getCurrentLanguage();
if (lang!="fr")
  lang ="en";
var author_forms_localization = {
"searching":     {"fr": "Recherche en cours...",
                  "en": "Searching..."},
"facet_limit":   {"fr": "Attention: ces résultats sont incomplets, car le paramètre facet.limit est actuellement fixé à une valeur trop basse ([param]) dans la fonction getFormesAuteurs().",
                  "en": "Warning: results are incomplete, because parameter facet.limit is currently set to a value too low ([param]) in function getFormesAuteurs()."},
"unknown-warn":  {"fr": "Un avertissement s'est produit lors de la récupération des résultats, mais il n'y a pas de message précis associé à cet avertissement",
                  "en": "A warning was issued during retrieval of these results, but there's no explanation message associated to this warning."}
};

	function insensitive(s) {
		return removeDiacritics(s.toLowerCase()).replace(new RegExp("[^a-z]", 'g'), " ");
	}

	function validClassName(s) {
		return removeDiacritics(s.toLowerCase()).replace(new RegExp("[^a-z]", 'g'), "-");
	}

	var listeMembres = [];
	var listeFormesAuteurs = [];
	var warnings = [];
	var facet_pivot_raw_data = undefined;
	var index_membres_par_nom = {};
	var index_membres_par_idhal_s = {};
	var doublons_sans_idhal = [];
	var liste_sans_doublons = [];
	$('#mybiblio-requirements').html(author_forms_localization['searching'][lang]);
	$("#mybiblio-requirements").removeClass('alert-danger');
	$("#mybiblio-requirements").addClass('alert-warning');
	$("#mybiblio-requirements").addClass('loading');
	$.when (getMembresLabo(function(liste) {listeMembres=liste;}, function(errno) {
			$('#liste_membres_labo').html("<tr><td>Une erreur est survenue lors de la recuperation de la liste des membres du labo.</td></tr>");
		}), getFormesAuteurs(my_config.code_collection, my_config.codes_structures_labo, function(liste, w, raw_data) {
				listeFormesAuteurs=liste;
				warnings=w;
				facet_pivot_raw_data = raw_data;
			}, function(errno) {
				$('#liste_membres_labo').html("<tr><td>Une erreur est survenue lors de la recuperation des formes auteurs.</td></tr>");
			}, facet_limit_for_query1)
	).done(function (response1, response2) {
		
		$('aside.legende').show();
		if (warnings && warnings.length) {
		  $('#mybiblio-requirements').html("");
		  warnings.forEach(function(e) {
		  	  if (author_forms_localization[e.warning])
			    $('#mybiblio-requirements').append(author_forms_localization[e.warning][lang].replace("[param]", e.param)+"<br/>");
			  else
			    $('#mybiblio-requirements').append(author_forms_localization['unknown-warn'][lang]+"<br/>");
		  });
		}
		
		Lazy(listeMembres).sortBy(function(x) {return x.nom+" "+x.prenom}).each(function(x){
			x.full_name=x.nom+" "+x.prenom;
			index_membres_par_nom[insensitive(x.full_name)]=x;
			if (x.idHal_s!="") {
				index_membres_par_idhal_s[x.idHal_s]=x;
			}
		});
				
		Lazy(listeFormesAuteurs).groupBy(function(x) {return x.name+':'+x.idhal}).each(function(x){var somme=0; for (var i = 0; i < x.length; i++) {somme+=x[i].nb_depots}; x[0].nb_depots=somme; liste_sans_doublons.push(x[0])});
		
		for (var i = 0; i < liste_sans_doublons.length; i++) {
			var index = index_membres_par_nom[insensitive(liste_sans_doublons[i].name)];
			if (index) {
				if (!index.formes_auteurs) { index.formes_auteurs = []; }
				index.formes_auteurs.push(liste_sans_doublons[i]);
				if (index.idHal_s=="") {
					index.idHal_s=liste_sans_doublons[i].idhal;
				}
			}
		}
		
		/* Récupération des dates des premiers et derniers dépôts pour tous les membres qui possèdent un idhal : 
		   (pour des questions d'optimisation, on présuppose ici que les facets sont triées par ordre lexical, c.a.d. &facet.sort=index)
		*/
		if (!jQuery.isEmptyObject(index_membres_par_idhal_s) && facet_pivot_raw_data && facet_pivot_raw_data.facet_counts.facet_pivot) {
			var facet_pivot_idhals = facet_pivot_raw_data.facet_counts.facet_pivot["authIdHal_s,submittedDateY_i,submittedDateM_i,submittedDateD_i"];
			if (facet_pivot_idhals !== undefined)
				for (var i = 0; i < facet_pivot_idhals.length; i++) {
	                var current_idhal  = facet_pivot_idhals[i].value;
	                if (index_membres_par_idhal_s[current_idhal] && index_membres_par_idhal_s[current_idhal].formes_auteurs)
	                	for (var j = 0; j < index_membres_par_idhal_s[current_idhal].formes_auteurs.length; j++) {
                			var current_member = index_membres_par_idhal_s[current_idhal].formes_auteurs[j];
	                		if (current_member.idhal!='') {
				                var most_recent_year  = facet_pivot_idhals[i].pivot[facet_pivot_idhals[i].pivot.length-1];
				                var most_recent_month = most_recent_year.pivot [most_recent_year.pivot.length-1];
				                var most_recent_day   = most_recent_month.pivot[most_recent_month.pivot.length-1];
				                var most_recent_date  = most_recent_year.value + '-' + ("00" + most_recent_month.value).slice(-2) + '-' + ("00" + most_recent_day.value).slice(-2);
				                if (!current_member.last_submit_date || most_recent_date > current_member.last_submit_date)
				                	current_member.last_submit_date = most_recent_date;
				                var oldest_year  = facet_pivot_idhals[i].pivot[0];
				                var oldest_month = oldest_year.pivot[0];
				                var oldest_day   = oldest_month.pivot[0];
				                var oldest_date  = oldest_year.value + '-' + ("00" + oldest_month.value).slice(-2) + '-' + ("00" + oldest_day.value).slice(-2);
				                if (!current_member.first_submit_date || oldest_date < current_member.first_submit_date)
				                	current_member.first_submit_date = oldest_date;
	                		}
	                	}
				}
		}
		
		for (var i = 0; i < liste_sans_doublons.length; i++) {
			if (!index_membres_par_nom[insensitive(liste_sans_doublons[i].name)]) {
				var index = index_membres_par_idhal_s[liste_sans_doublons[i].idhal];
				var mots = insensitive(liste_sans_doublons[i].name).split(/\s/);
				if (!index) { index = index_membres_par_nom[mots[0]+" "+mots.slice(2).join(" ")]; }
				if (!index) { index = index_membres_par_nom[mots.slice(0,mots.length-1).join(" ")]; }
				if (!index && mots.length==2) { index = index_membres_par_nom[mots[1]+" "+mots[0]]; }
				if (index) {
					if (!index.formes_auteurs) { index.formes_auteurs = []; }
					index.formes_auteurs.push(liste_sans_doublons[i]);
				} else {
					// c'est un inconnu, on le rajoute :
					listeMembres.push({"full_name":liste_sans_doublons[i].name ,"idHal_s":liste_sans_doublons[i].idhal ,"formes_auteurs":[liste_sans_doublons[i]] });
					index_membres_par_nom[insensitive(liste_sans_doublons[i].name)]=listeMembres[listeMembres.length];
					if (liste_sans_doublons[i].idhal!="") {
						index_membres_par_idhal_s[liste_sans_doublons[i].idhal]=listeMembres[listeMembres.length];
					}
				}
			}
		}		
		
		Lazy(listeMembres).each(function(membre) {
			if (!membre.formes_auteurs) { membre.formes_auteurs = []; }
			if (membre.formes_auteurs.length==0) {
				if (membre.idHal_s!="")	{ // s'il possède un idhal, il a droit de cité !
					membre.formes_auteurs.push({idhal: membre.idHal_s, name: membre.nom+" "+membre.prenom, nb_depots: 0});
				}
			}
		});
				
		var output_code = "";
		Lazy(listeMembres).sortBy(function(m) {return m.full_name}).each(function(membre) {
			Lazy(membre.formes_auteurs).each(function (forme_auteur) {
				var forme_non_associee_a_l_idhal=(membre.idHal_s!="" && forme_auteur.idhal=="");
				var membre_officiel=(membre.nom && membre.prenom);
				if (forme_non_associee_a_l_idhal) {
					doublons_sans_idhal.push(forme_auteur);
				}
				output_code=output_code+"<tr class='"+(membre.date_depart?'parti ':' ')+(forme_non_associee_a_l_idhal?'idhal-manquant ':'')+"' "+(forme_non_associee_a_l_idhal? "id='doublon-"+validClassName(forme_auteur.name)+"'":"")+">";
				output_code=output_code+"<td"+(!membre_officiel? " class='inconnu'":"")+">"+forme_auteur.name+"</td>";
				output_code=output_code+"<td>"+(forme_auteur.idhal==""?"":'<span class="glyphicon glyphicon-user" data-toggle="tooltip" data-placement="auto" data-original-title="IdHal de l\'auteur"></span>&nbsp;')+forme_auteur.idhal+"</td>";
				var name = forme_auteur.name.split(/\s/);
				output_code=output_code+"<td><a target='blank' class='btn "+(forme_auteur.nb_depots>0?"btn-primary":"btn-default")+" btn-xs pull-right' href='https://hal.archives-ouvertes.fr/"+my_config.code_collection+"/search/index/?"+ ( forme_auteur.idhal=="" ? "qa%5BauthFullName_s%5D%5B%5D=%22"+encodeURIComponent(name[name.length-1]+" "+name.splice(0,name.length-1).join(" "))+"%22" : "&qa%5BauthIdHal_s%5D%5B%5D="+forme_auteur.idhal ) + "&submit_advanced=Rechercher&rows=30&sort=submittedDate_tdate+desc'>"+forme_auteur.nb_depots+"</a></td>";
				output_code=output_code+(forme_auteur.first_submit_date?"<td>"+forme_auteur.first_submit_date:"<td>")+"</td>";
				output_code=output_code+(forme_auteur.last_submit_date?"<td>"+forme_auteur.last_submit_date:"<td>")+"</td>";
				output_code=output_code+(membre.date_arrivee?"<td>"+membre.date_arrivee:"<td>")+"</td>";
				output_code=output_code+(membre.date_depart?"<td class='parti'>"+membre.date_depart:"<td>")+"</td></tr>";
				return true;
			});
		});
		
		if (output_code!="") {
			$('#liste_membres_labo').html("<thead><tr><th>Nom Prénom</th><th>idhal_s</th><th>Dépôts "+my_config.code_collection+"</th><th>Premier d&eacute;p&ocirc;t "+my_config.code_collection+"</th><th>Dernier d&eacute;p&ocirc;t "+my_config.code_collection+"</th><th>Arrivé le</th><th>Parti le</th></tr></thead><tbody>"+output_code+"</tbody>");
		}
		if (doublons_sans_idhal.length>0) {
			var query = "("+encodeURIComponent(doublons_sans_idhal[0].name)+")";
			for (var i = 1; i < doublons_sans_idhal.length; i++) {
				query = query + "+OR+("+encodeURIComponent(doublons_sans_idhal[i].name)+")";
			}
			for (var i = 0; i < doublons_sans_idhal.length; i++) {
				$('tr#doublon-'+validClassName(doublons_sans_idhal[i].name)+' td:nth-child(3)').html(doublons_sans_idhal[i].nb_depots);
			}
			console.log(query);
			$.ajax("https://api.archives-ouvertes.fr/search/"+my_config.code_collection, {data: 'q=authFullName_t:'+query+'&rows=1&sort=submittedDate_tdate%20desc&fl=submittedDate_s&rows=0&wt=json&facet=true&facet.field=authIdHasStructure_fs&facet.mincount=1&facet.limit='+facet_limit_for_query2, dataType: 'json', jsonp: false, success: function( d ) {
			  var reponses = d.facet_counts.facet_fields.authIdHasStructure_fs;
			  if (reponses !== undefined) {
  				  var index_authors = [];
				  for (var i = 0; i < reponses.length; i+=2) {
				    var rep = reponses[i]+'';
				    rep = rep.split(/_FacetSep_|_JoinSep_/);
				    if (rep[2]=="199944" || rep[2]=="107319") {
				    	var name = rep[1].split(/\s/);
				    	index_authors[rep[0]]={"full_name": name.splice(1).join(" ")+" "+name[0], "nb_depots": reponses[i+1]};
				    }
				  }
				  		  	
				  /* Récupération des dates des premiers et derniers dépôts pour tous les membres qui ne possèdent pas d'idhal :
				   (pour des questions d'optimisation, on présuppose ici que les facets sont triées par ordre lexical, c.a.d. &facet.sort=index)
				  */
				  if (index_authors.length > 0 && d && d.facet_counts.facet_pivot) {
					var facet_pivot_years = d.facet_counts.facet_pivot["submittedDateY_i,submittedDateM_i,submittedDateD_i,authId_i"];		
					if (facet_pivot_years !== undefined)
						for (var i = 0; i < facet_pivot_years.length; i++) {
			                var current_pivot_year  = facet_pivot_years[i].value;
			                var facet_pivot_monthes = facet_pivot_years[i].pivot;
			                for (var j = 0; j < facet_pivot_monthes.length; j++) {
			                	var current_pivot_month  = facet_pivot_monthes[j].value;
			                	var facet_pivot_days     = facet_pivot_monthes[j].pivot;
			                	for (var k = 0; k < facet_pivot_days.length; k++) {
			                		var current_pivot_day   = facet_pivot_days[k].value;
			                		var facet_pivot_authors = facet_pivot_days[k].pivot;
			                		var current_pivot_date  = current_pivot_year + '-' + ("00" + current_pivot_month).slice(-2) + '-' + ("00" + current_pivot_day).slice(-2);
				                	for (var l = 0; l < facet_pivot_authors.length; l++) {
				                		var current_pivot_author = index_authors[facet_pivot_authors[l].value];
				                		if (current_pivot_author) {
				                			if (!current_pivot_author.last_submit_date || current_pivot_author.last_submit_date < current_pivot_date)
					                			current_pivot_author.last_submit_date = current_pivot_date;
				                			if (!current_pivot_author.first_submit_date || current_pivot_author.first_submit_date > current_pivot_date)
					                			current_pivot_author.first_submit_date = current_pivot_date;							                					}
				                	}
			                	}
			                }
						}
				  }
				
	  			  Object.keys(index_authors).forEach(function (author_id, i) {
	  			  		var className = "doublon-"+validClassName(index_authors[author_id].full_name)
				  		$('tr#'+className+' td:nth-child(3)').html( ( author_id ? "<a target='blank' class='btn btn-default btn-xs pull-right' href='https://hal.archives-ouvertes.fr/"+my_config.code_collection+"/search/index/q/authId_i%3A"+author_id+"/rows/30/&sort=submittedDate_tdate+desc'>"+index_authors[author_id].nb_depots+"</a>" : index_authors[author_id].nb_depots ) );
				  		$('tr#'+className+' td:nth-child(4)').html( index_authors[author_id].first_submit_date );
				  		$('tr#'+className+' td:nth-child(5)').html( index_authors[author_id].last_submit_date );
				  });
			  }
			  $('#mybiblio-requirements').html("");
			  $("#mybiblio-requirements").removeClass('loading');
			  if (!warnings || !warnings.length)
			    $('#mybiblio-requirements').hide();
			}});
		} else {
			$('#mybiblio-requirements').html("");
			$("#mybiblio-requirements").removeClass('loading');
			if (!warnings || !warnings.length)
			  $('#mybiblio-requirements').hide();
		}
	});
// ]]></script>

</body>
</html>
